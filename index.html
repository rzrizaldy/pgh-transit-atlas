<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGH_TRANSIT_ATLAS // 2025</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- PALETTE: Neo-Brutalist Schematic --- */
            --paper: #F2F0E9;
            --ink: #1A1A1A;
            --blueprint: #2B4CFF;
            --safety-orange: #FF4D00;
            --terminal-green: #00B884;
            --alert-pink: #FF2B8C;
            --grid-color: #D1D1D1;
            
            /* --- STRUCTURE --- */
            --border-heavy: 3px solid var(--ink);
            --border-light: 1px solid var(--ink);
            --shadow-deep: 6px 6px 0px var(--ink);
            --shadow-shallow: 3px 3px 0px var(--ink);
            --radius: 0px; /* Brutalist = No rounded corners */
        }

        body {
            background-color: var(--paper);
            /* Technical Grid Background */
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--ink);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- UI COMPONENTS --- */
        
        /* Top Navigation Bar */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-bottom: var(--border-heavy);
            padding: 0 20px;
            height: 70px;
            z-index: 1000;
        }

        .brand {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span {
            background: var(--ink);
            color: white;
            padding: 2px 8px;
            font-size: 0.9rem;
        }

        .mode-switch {
            display: flex;
            gap: 15px;
        }

        button.retro-btn {
            background: white;
            border: var(--border-heavy);
            padding: 10px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: var(--shadow-shallow);
            transition: all 0.1s;
            position: relative;
        }

        button.retro-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: var(--shadow-deep);
        }

        button.retro-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        button.retro-btn.active {
            background: var(--blueprint);
            color: white;
            box-shadow: none;
            transform: translate(2px, 2px);
        }

        /* Main Container */
        main {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view-section {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .view-section.active {
            opacity: 1;
            pointer-events: all;
        }

        /* --- VIZ VIEW LAYOUT (VERTICAL SCROLLING) --- */
        .viz-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 40px;
        }

        .viz-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .viz-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .panel {
            background: white;
            border: var(--border-heavy);
            box-shadow: var(--shadow-deep);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: var(--ink);
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .panel-controls {
            display: flex;
            gap: 5px;
        }

        .control-dot {
            width: 10px; height: 10px;
            background: white;
            border: 1px solid black;
        }

        /* Specific Panels */
        .control-panel {
            padding: 20px;
            background: var(--paper);
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid black;
            font-family: inherit;
            background: white;
            font-size: 0.95rem;
        }

        #map-wrapper {
            min-height: 500px;
            padding: 0;
        }

        .chart-panel {
            min-height: 500px; /* Increased from 350px for better visibility */
            padding: 15px;
        }

        .insight-panel {
            padding: 20px;
            background: linear-gradient(135deg, #fffdf5 0%, #fff 100%);
            min-height: 200px; /* Ensure insights have space */
        }

        .insight-header {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
            margin-bottom: 10px;
            color: var(--blueprint);
        }

        .insight-body {
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .metric-highlight {
            display: inline-block;
            background: var(--safety-orange);
            color: white;
            padding: 2px 8px;
            font-weight: bold;
            margin: 0 4px;
        }

        .policy-box {
            background: white;
            border-left: 5px solid var(--alert-pink);
            padding: 20px;
            margin-bottom: 15px;
        }

        .policy-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .policy-desc {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .policy-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-tag {
            padding: 6px 12px;
            background: var(--blueprint);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid black;
        }

        /* Map Styling */
        #map { height: 100%; width: 100%; background: #ddd; }
        
        /* Metric Cards in Sidebar */
        .stat-card {
            border: var(--border-light);
            margin-bottom: 15px;
            padding: 10px;
            background: #fff;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--blueprint);
        }
        .stat-context {
            font-size: 0.7rem;
            margin-top: 5px;
            border-top: 1px dashed #ccc;
            padding-top: 5px;
        }

        /* --- NOTEBOOK VIEW LAYOUT --- */
        .notebook-container {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 50px;
        }

        .nb-cell {
            background: white;
            border: var(--border-heavy);
            margin-bottom: 30px;
            box-shadow: var(--shadow-shallow);
        }

        .nb-input {
            background: #f8f8f8;
            border-bottom: var(--border-light);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            position: relative;
        }

        .nb-input::before {
            content: "IN [ ]:";
            position: absolute;
            left: -60px;
            top: 15px;
            font-weight: bold;
            color: var(--blueprint);
        }

        .nb-output {
            padding: 20px;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .nb-md {
            padding: 20px;
            line-height: 1.6;
            background: #fffdf5; /* warm notes color */
        }

        .code-highlight { color: #d63384; }
        .comment { color: #6c757d; font-style: italic; }
        .function { color: var(--blueprint); font-weight: bold; }

        /* --- ABOUT VIEW LAYOUT --- */
        #about-view {
            max-width: 1200px;
            margin: 0 auto;
            padding-top: 40px;
            padding-bottom: 60px;
        }

        /* ROW 1: CONTEXT GRID */
        .context-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 60px;
        }

        .log-header {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem;
            border-bottom: var(--border-heavy);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--ink);
            font-weight: 800;
            text-transform: uppercase;
        }

        /* PHOTO TILES */
        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .evidence-tile {
            border: var(--border-heavy);
            background: white;
            padding: 10px;
            transform: rotate(-1deg);
            transition: transform 0.2s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .evidence-tile:nth-child(even) {
            transform: rotate(1deg);
        }

        .evidence-tile:hover {
            transform: rotate(0deg) scale(1.02);
            box-shadow: var(--shadow-deep);
            z-index: 10;
        }

        .evidence-placeholder {
            width: 100%;
            height: 150px;
            background: #eee;
            border-bottom: var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #ccc;
            overflow: hidden;
        }
        
        .evidence-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(100%);
        }

        .evidence-label {
            font-family: 'JetBrains Mono';
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 10px;
            display: block;
            color: var(--safety-orange);
        }

        /* --- ROW 2: AUTHOR SECTION --- */
        .author-section {
            border-top: var(--border-heavy);
            padding-top: 40px;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 40px;
        }

        /* AUTHOR SIDEBAR */
        .author-sidebar {
            text-align: center;
        }

        .author-photo {
            width: 100%;
            aspect-ratio: 1/1;
            background: #ddd;
            border: var(--border-heavy);
            margin-bottom: 20px;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .author-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .connect-btn {
            display: block;
            width: 100%;
            background: var(--ink);
            color: white;
            padding: 15px;
            margin-bottom: 10px;
            text-decoration: none;
            font-family: 'Space Grotesk';
            font-weight: bold;
            border: 2px solid transparent;
            transition: all 0.1s;
            box-sizing: border-box;
            text-align: center;
            font-size: 0.9rem;
        }

        .connect-btn:hover {
            background: var(--safety-orange);
            transform: translate(-4px, -4px);
            box-shadow: 6px 6px 0px var(--ink);
            border: var(--border-heavy);
            color: var(--ink);
        }

        /* AUTHOR BIO */
        .author-bio p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 1rem;
            font-family: 'Space Grotesk', sans-serif;
        }

        .author-bio strong {
            color: var(--blueprint);
        }

        /* RESPONSIVE */
        @media (max-width: 800px) {
            .context-row { grid-template-columns: 1fr; }
            .author-section { grid-template-columns: 1fr; }
            .author-photo { width: 200px; margin: 0 auto 20px auto; }
        }

        /* Ticker */
        .ticker-tape {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--safety-orange);
            color: white;
            border-top: var(--border-heavy);
            padding: 5px;
            white-space: nowrap;
            overflow: hidden;
            font-size: 0.8rem;
            z-index: 2000;
        }
        
        @media (max-width: 1000px) {
            .viz-grid { grid-template-columns: 1fr; grid-template-rows: auto; display: flex; flex-direction: column; }
            .nb-input::before { display: none; }
        }
    </style>
</head>
<body>

    <!-- NAV -->
    <nav>
        <div class="brand">
            <div>PGH_TRANSIT_ATLAS</div>
            <div style="font-size: 0.75rem; margin-top: 5px; font-weight: normal; letter-spacing: 0.5px; line-height: 1.4;">
                <span style="background: black; color: white; padding: 2px 6px; font-weight: bold;">(by Rizaldy Utomo - Public Policy, Analytics, AI Management @ CMU)</span>
            </div>
        </div>
        <div class="mode-switch">
            <button class="retro-btn active" onclick="toggleMode('viz')">1. INTERACTIVE VIZ</button>
            <button class="retro-btn" onclick="toggleMode('eda')">2. CODE & METHODS</button>
            <button class="retro-btn" onclick="toggleMode('about')">3. CONTEXT / LOG</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main>
        <!-- VIEW 1: VIZ DASHBOARD (VERTICAL SCROLL DESIGN) -->
        <section id="viz-view" class="view-section active">
            <div class="viz-grid">

                <!-- SECTION 1: CONTROLS & FILTERS -->
                <div class="viz-section">
                    <div class="panel control-panel">
                        <div class="panel-header">
                            <span>// INTERACTIVE FILTERS</span>
                            <div class="panel-controls"><div class="control-dot"></div></div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 15px;">
                            <div class="filter-group">
                                <label>CORRIDOR FOCUS</label>
                                <select id="corridor-filter">
                                    <option value="system">üåê System Wide</option>
                                    <option value="campus">üéì Campus Corridor (CMU/Pitt)</option>
                                    <option value="downtown">üèôÔ∏è Downtown Triangle</option>
                                    <option value="east-liberty">üöá Oakland-East Liberty</option>
                                    <option value="strip">üè≠ Strip District</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label>STATION FOCUS</label>
                                <select id="station-filter">
                                    <option value="all">All Stations</option>
                                    <option value="top10-pogoh">üèÜ Top 10 POGOH Stations</option>
                                    <option value="top10-prt">üöå Top 10 PRT Stops</option>
                                </select>
                            </div>
                        </div>

                        <div style="padding: 0 15px 15px 15px;">
                            <button class="retro-btn" id="apply-filters-btn" style="width: 100%; background: var(--terminal-green); color: white; font-size: 1rem;">
                                ‚ö° APPLY FILTERS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: MAP + KEY INSIGHTS -->
                <div class="viz-section">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <!-- Map -->
                        <div class="panel" id="map-wrapper">
                            <div class="panel-header">
                                <span>// SYSTEM_BLUEPRINT_MAP</span>
                                <div class="panel-controls"><div class="control-dot"></div><div class="control-dot"></div></div>
                            </div>
                            <div id="map"></div>
                            <div style="position: absolute; bottom: 20px; right: 20px; background: white; border: 2px solid black; padding: 10px; z-index: 999; font-size: 0.8rem;">
                                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                                    <div style="width:12px; height:12px; background:var(--blueprint); border-radius:50%;"></div> PRT Stop (Size=Vol)
                                </div>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <div style="width:12px; height:12px; background:var(--alert-pink); border:1px solid black;"></div> POGOH Station
                                </div>
                            </div>
                        </div>

                        <!-- Key Metrics -->
                        <div class="panel insight-panel">
                            <div class="insight-header">üìä KEY INSIGHTS</div>
                            <div class="insight-body" id="dynamic-insights">
                                <p><strong>System Overview:</strong> PRT serves <span class="metric-highlight" id="prt-daily-metric">~834K</span> daily riders while POGOH contributes <span class="metric-highlight" id="pogoh-daily-metric">~3.4K</span> trips (Oct 2025 peak).</p>

                                <p><strong>Campus Dominance:</strong> <span class="metric-highlight">68.1%</span> of all bike trips originate or terminate in the CMU/Pitt corridor, showing university-centric adoption.</p>

                                <p><strong>Integration Gap:</strong> Only <span class="metric-highlight">11.5%</span> of bus stops have meaningful bike activity within 400m walking distance.</p>

                                <p style="margin-top:15px; padding-top:15px; border-top:2px solid #ddd;"><strong>üéØ Filter Active:</strong> <span id="filter-status">System-Wide View</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: TEMPORAL PATTERNS (DUAL CHARTS) -->
                <div class="viz-section">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 1A. POGOH DAILY RIDERSHIP (365 Days)</span></div>
                            <div style="padding:20px; min-height:400px;">
                                <canvas id="pogohDailyChart"></canvas>
                            </div>
                        </div>

                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 1B. PRT BUS RIDERSHIP (Monthly Trend)</span></div>
                            <div style="padding:20px; min-height:400px;">
                                <canvas id="prtMonthlyChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="panel insight-panel">
                        <div class="insight-header">üìà Temporal Analysis</div>
                        <div class="insight-body">
                            <p><strong>Scale Difference:</strong> PRT serves <span class="metric-highlight">~834K</span> daily riders while POGOH contributes <span class="metric-highlight">~3.4K</span> daily trips (247x difference), showing buses as primary transit mode.</p>
                            <p><strong>Seasonal Volatility:</strong> POGOH shows extreme seasonal fluctuation (13x from winter low to fall peak), while PRT remains stable (~611K-835K range).</p>
                            <p><strong>Academic Calendar Impact:</strong> Sep/Oct surge (+86% from August) coincides with fall semester, confirming student-driven demand.</p>
                            <p><strong>Winter Resilience:</strong> PRT actually grows in winter months while POGOH drops -63%, suggesting bikes fail as winter alternative.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION 4: TRIP PATTERNS (2x2 Grid) -->
                <div class="viz-section">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 2. TRIP ARCHETYPES (K-Means)</span></div>
                            <div style="padding:20px; min-height:350px;">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>

                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 3. DIRECTIONAL FLOW</span></div>
                            <div style="padding:20px; min-height:350px;">
                                <canvas id="polarChart"></canvas>
                            </div>
                        </div>

                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 4. SEASONAL HOURLY PATTERNS</span></div>
                            <div style="padding:20px; min-height:350px;">
                                <canvas id="seasonalChart"></canvas>
                            </div>
                        </div>

                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 5. TRIP DURATION DISTRIBUTION</span></div>
                            <div style="padding:20px; min-height:350px;">
                                <canvas id="durationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="panel insight-panel">
                        <div class="insight-header">üö≤ Usage Patterns Analysis</div>
                        <div class="insight-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>Archetypes:</strong> <span class="metric-highlight">Commuters (47.9%)</span> dominate with short, consistent trips, followed by Last-Mile users (32.8%). Leisure rides are minimal (3.6%).</p>
                                <p><strong>Flow:</strong> Strong <span class="metric-highlight">North-South</span> axis alignment suggests heavy movement between Oakland/Shadyside and East Liberty corridors.</p>
                            </div>
                            <div>
                                <p><strong>Seasonality:</strong> Fall semester (Sep-Nov) drives peak hourly usage. Winter usage retains only ~37% of peak volume, indicating weather sensitivity.</p>
                                <p><strong>Durations:</strong> Median trip is <span class="metric-highlight">~7 mins</span>. The sharp decay after 15 mins confirms POGOH is used primarily for efficient A-to-B transit, not recreation.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 5: STATION DEMOGRAPHICS -->
                <div class="viz-section">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="panel chart-panel">
                            <div class="panel-header">
                                <span>FIG 6. TOP 10 STATIONS (Member vs Casual)</span>
                                <div style="float: right; margin-left: 20px;">
                                    <label style="font-size: 0.75rem; margin-right: 5px;">Sort by:</label>
                                    <select id="demo-sort" style="font-family: 'JetBrains Mono'; font-size: 0.7rem; padding: 2px 5px; background: #fff; border: 1px solid #000;">
                                        <option value="total">Total Trips</option>
                                        <option value="casual">Casual %</option>
                                        <option value="member">Member %</option>
                                    </select>
                                </div>
                            </div>
                            <div style="padding:20px; min-height:400px;">
                                <canvas id="demographicsChart"></canvas>
                            </div>
                        </div>

                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 7. BUS-BIKE CORRELATION</span></div>
                            <div style="padding:20px; min-height:400px;">
                                <canvas id="correlationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="panel insight-panel">
                        <div class="insight-header">üë• User & Network Analysis</div>
                        <div class="insight-body">
                            <p><strong>Membership Economy:</strong> <span class="metric-highlight">~70%</span> of trips at top stations are from Members (Students/Locals). Casual use is concentrated in Downtown/Strip District.</p>
                            <p><strong>Network Effect:</strong> Moderate positive correlation (R¬≤=0.37) confirms that high-volume bus stops drive bikeshare usage, but proximity gaps remain.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION 6: STRATEGIC INTEGRATION (NEW) -->
                <div class="viz-section">
                     <div class="panel chart-panel">
                        <div class="panel-header"><span>FIG 8. TOP 10 PRT STOPS NEAR POGOH (Integration Potential)</span></div>
                        <div style="padding:20px; min-height:400px;">
                            <canvas id="topPrtChart"></canvas>
                        </div>
                    </div>

                    <div class="panel insight-panel">
                        <div class="insight-header">üîó Multimodal Opportunities</div>
                        <div class="insight-body">
                            <p><strong>The "Last-Mile" Leaders:</strong> These 10 PRT stops are the most critical multimodal nodes. They have high bus volume AND are within 400m of a POGOH station.</p>
                            <p><strong>Gap Analysis:</strong> While <span class="metric-highlight">Forbes & Morewood</span> sees massive bus traffic (Carnegie Mellon), bike uptake is lower compared to <span class="metric-highlight">Liberty & Gateway</span>, suggesting infrastructure quality varies.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION 7: INTEGRATION LEAGUE TABLE -->
                <div class="viz-section">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 9. TOP NEIGHBORHOODS BY BUS-BIKE INTEGRATION</span></div>
                            <div style="padding:20px; min-height:400px;">
                                <canvas id="neighborhoodIntegrationChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="panel chart-panel">
                            <div class="panel-header"><span>FIG 10. INTEGRATION INDEX DISTRIBUTION (Top 15 Stops)</span></div>
                            <div style="padding:20px; min-height:400px;">
                                <canvas id="topIndexChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel insight-panel">
                        <div class="insight-header">üèÜ The Integration Leaderboard</div>
                        <div class="insight-body">
                            <p><strong>What This Measures:</strong> The <em>Integration Index</em> rewards bus stops that have high ridership AND high nearby bike turnover.</p>
                            <p><strong>Winner:</strong> <span class="metric-highlight">Central Business District</span> dominates due to density. <span class="metric-highlight">Strip District</span> and <span class="metric-highlight">North Shore</span> follow, showing the value of flat terrain and bike lanes.</p>
                            <p><strong>Top Stop:</strong> <span class="metric-highlight">7th St @ Penn Ave</span> is the "Golden Node" of the network, proving that bus lanes + protected bike lanes = maximum multimodal flow.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION 8: STATION ARCHETYPES -->
                <div class="viz-section">
                    <div class="panel chart-panel">
                        <div class="panel-header"><span>FIG 11. BEHAVIORAL HOTSPOTS (Top 3 Stations per Archetype)</span></div>
                        <div style="padding:20px; min-height:500px;">
                            <canvas id="stationArchetypesChart"></canvas>
                        </div>
                    </div>

                    <div class="panel insight-panel">
                        <div class="insight-header">üé≠ Station Personalities</div>
                        <div class="insight-body">
                            <p><strong>Commuter Hubs:</strong> <span class="metric-highlight">Schenley Dr (64.8%)</span> and <span class="metric-highlight">Forbes @ CMU (61.2%)</span> are pure commuter stations‚Äîpeak hour, A-to-B efficiency dominates.</p>
                            <p><strong>Last-Mile Connectors:</strong> <span class="metric-highlight">Boulevard of the Allies (46.9%)</span> shows high last-mile percentage, serving as a critical transit feeder.</p>
                            <p><strong>Errand Centers:</strong> <span class="metric-highlight">Wilkinsburg Park & Ride (68.4%!)</span> is overwhelmingly errand-focused, suggesting suburban shopping/service trip patterns.</p>
                            <p><strong>Leisure Destinations:</strong> <span class="metric-highlight">South Side Trail (19.0%)</span> captures recreational riders‚Äîlonger durations, lower displacement (circular routes).</p>
                            <p><strong>Policy Insight:</strong> Stations have behavioral "DNA". Tailor rebalancing schedules and pricing to match: peak hour density for commuter hubs, leisure pricing at recreational nodes.</p>
                        </div>
                    </div>
                </div>

                <!-- SECTION 9: POLICY RECOMMENDATIONS (MOVED TO BOTTOM) -->
                <div class="viz-section">
                    <div class="panel" style="padding:30px; background:#fff9f5;">
                        <h2 style="font-family:'Space Grotesk'; font-size:1.8rem; border-bottom:4px solid var(--alert-pink); padding-bottom:10px; margin-bottom:25px;">
                            üéØ POLICY RECOMMENDATIONS
                        </h2>

                        <div class="policy-box">
                            <div class="policy-title">1. Fill the Homewood & Squirrel Hill Gaps</div>
                            <div class="policy-desc">
                                <strong>Issue:</strong> Two high-traffic corridors lack adequate POGOH coverage:<br>
                                ‚Ä¢ <strong>Homewood:</strong> 4 high-volume bus stops (>800 boardings/day) have NO bike stations within 800m walking distance<br>
                                ‚Ä¢ <strong>Squirrel Hill:</strong> Despite significant bus traffic along Forbes Ave and Murray Ave, POGOH stations are sparse, forcing residents to walk 600-1000m to access bikes<br>
                                <strong>Action:</strong> Deploy 2 new stations in Homewood (Homewood-Brushton Busway, N. Homewood Ave) and 2 in Squirrel Hill (Forbes @ Murray, Murray @ Forward) to serve 18K+ daily bus riders.
                            </div>
                            <div class="policy-actions">
                                <span class="action-tag">EQUITY</span>
                                <span class="action-tag">FIRST/LAST MILE</span>
                            </div>
                        </div>

                        <div class="policy-box">
                            <div class="policy-title">2. Winter Gear & Fleet Resilience</div>
                            <div class="policy-desc">
                                <strong>Issue:</strong> 63% ridership drop in January shows weather deterrence. Riders freeze and batteries drain.<br>
                                <strong>Action:</strong> Distribute subsidized POGOH-branded winter riding kits (gloves/buffs) to students and prioritize battery heating/swapping for e-fleet reliability in &lt;30¬∞F.
                            </div>
                            <div class="policy-actions">
                                <span class="action-tag">SEASONAL</span>
                                <span class="action-tag">RETENTION</span>
                            </div>
                        </div>

                        <div class="policy-box">
                            <div class="policy-title">3. Downtown Triangle Densification</div>
                            <div class="policy-desc">
                                <strong>Issue:</strong> 7TH & PENN shows highest integration score (3,732) but surrounding blocks are underserved.<br>
                                <strong>Action:</strong> Add 3 micro-hubs (10 docks each) within 200m of Point State Park to capture tourist + commuter demand.
                            </div>
                            <div class="policy-actions">
                                <span class="action-tag">HIGH-ROI</span>
                                <span class="action-tag">TOURISM</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- VIEW 2: NOTEBOOK / EDA -->
        <section id="eda-view" class="view-section">
            <div class="notebook-container">
                
                <h1 style="font-family: 'Space Grotesk'; font-size: 2.5rem; border-bottom: 5px solid black; padding-bottom: 10px;">METHODOLOGY LOG</h1>
                <p style="margin-bottom: 20px;">Documentation of exploratory data analysis process, combining raw POGOH and PRT data (XLSX and CSV) into features and insight for web dashboard. All processed data are stored in <code style="background: #ffe066; padding: 2px 6px; font-weight: bold;">/processed_data/</code></p>

                <div style="background: var(--ink); color: white; padding: 15px 20px; margin-bottom: 40px; border-left: 5px solid var(--blueprint); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">
                    <strong>üìÅ CSV Outputs (./processed_data/):</strong><br>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <code style="color: #fff;">archetypes.csv (4 rows)</code><br>
                            <code style="color: #fff;">bike_stations_geo.csv (60 rows)</code><br>
                            <code style="color: #fff;">bus_stops_geo.csv (100 rows)</code><br>
                            <code style="color: #fff;">correlation.csv (2,720 rows)</code><br>
                            <code style="color: #fff;">daily_timeseries.csv (365 rows)</code><br>
                            <code style="color: #fff;">demographics.csv (10 rows)</code><br>
                            <code style="color: #fff;">directionality.csv (8 rows)</code>
                        </div>
                        <div>
                            <code style="color: #fff;">duration_distribution.csv (30 rows)</code><br>
                            <code style="color: #fff;">heatmap_hour_day.csv (24 rows)</code><br>
                            <code style="color: #fff;">heatmap_hour_season.csv (24 rows)</code><br>
                            <code style="color: #fff;">monthly_trends.csv (12 rows)</code><br>
                            <code style="color: #fff;">prt_historical.csv (8 rows)</code><br>
                            <code style="color: #fff;">top_prt_pogoh.csv (10 rows)</code>
                        </div>
                    </div>
                </div>

                <!-- CELL 1: DATA INGESTION -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>1. Data Pipeline & Ingestion</h3>
                        <p>The foundation of this dashboard is a robust ETL pipeline integrating disparate datasets from WPRDC (Western Pennsylvania Regional Data Center). We normalize, clean, and spatially join millions of records across multiple temporal granularities.</p>
                        <p><strong>Data Sources:</strong></p>
                        <ul>
                            <li><code>PRT_Bus_Stop_Usage.csv</code> ‚Äî 19,849 stops, monthly ridership 2019-2025 (70+ months historical)</li>
                            <li><code>POGOH_Trip_Data.xlsx</code> ‚Äî 556,515 trips (Nov 2024 - Oct 2025, 12 monthly files concatenated)</li>
                            <li><code>Station_Locations.geojson</code> ‚Äî 60 active bikeshare hubs with dock capacity</li>
                        </ul>
                        <p><strong>Data Quality Controls:</strong></p>
                        <ul>
                            <li>Removed trips > 4 hours (likely stolen bikes or system errors)</li>
                            <li>Filtered bus stops with zero ridership across all months</li>
                            <li>Haversine distance validation for impossible trip speeds (>50 km/h)</li>
                            <li>Date range validation to exclude test data outside 2024-2025 window</li>
                        </ul>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 1. ETL PROCESS (etl.py - Python/Pandas/NumPy)</span><br>
                        <span class="function">import</span> pandas <span class="function">as</span> pd, numpy <span class="function">as</span> np<br>
                        <span class="function">from</span> pathlib <span class="function">import</span> Path<br><br>
                        <span class="comment"># Ingest POGOH trip data from 12 monthly Excel files</span><br>
                        monthly_files = sorted(Path('data').glob('HealthyRide*.xlsx'))<br>
                        trips = pd.concat([pd.read_excel(f) <span class="function">for</span> f <span class="function">in</span> monthly_files], ignore_index=True)<br><br>
                        <span class="comment"># Clean outliers and parse timestamps</span><br>
                        trips['Duration'] = pd.to_numeric(trips['Duration'], errors='coerce')<br>
                        trips = trips[trips['Duration'] < 14400]  <span class="comment"># < 4 hours</span><br>
                        trips['Start Date'] = pd.to_datetime(trips['Start Date'])<br><br>
                        <span class="comment"># Ingest PRT bus stop data</span><br>
                        bus_stops = pd.read_csv('data/prt_stops.csv')<br>
                        <span class="function">print</span>(f"Loaded {len(trips):,} trips, {len(bus_stops):,} bus stops")
                    </div>
                    <div class="nb-output">
                        <strong>‚úì Ingestion Complete:</strong><br>
                        ‚Ä¢ Total Valid Bike Trips: <strong>556,515</strong> (after removing 12,438 outliers)<br>
                        ‚Ä¢ Total Bus Stops Analyzed: <strong>7,075</strong> (filtered from 19,849 raw records)<br>
                        ‚Ä¢ Date Range: <strong>Nov 1, 2024 ‚Üí Oct 31, 2025</strong> (365 days)<br>
                        ‚Ä¢ Average Trip Duration: <strong>17.3 minutes</strong> (median: 11.2 min)<br>
                        ‚Ä¢ Campus Corridor Trips: <strong>68.1%</strong> of total volume (379,039 trips)
                    </div>
                </div>

                <!-- CELL 2: FEATURE ENGINEERING -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>2. Feature Engineering & Metrics</h3>
                        <p>To derive meaning from raw trip logs, we construct advanced spatial and temporal features. The core innovation is the <strong>Integration Index</strong>‚Äîa composite score ranking bus stops by their potential to serve as multimodal hubs.</p>
                        <p><strong>Feature Categories:</strong></p>
                        <ul>
                            <li><strong>Spatial:</strong> Haversine distance calculations, 400m walkshed buffers, campus corridor geofencing (40.435-40.450¬∞N, -79.970 to -79.940¬∞W)</li>
                            <li><strong>Temporal:</strong> Hour of day, day of week, month, season (Winter/Spring/Summer/Fall based on academic calendar)</li>
                            <li><strong>Behavioral:</strong> Trip displacement (straight-line distance), duration bins, directionality (bearing angles)</li>
                            <li><strong>Integration:</strong> Bus-to-bike proximity matrix, 400m trip volume aggregation per bus stop</li>
                        </ul>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 2. SPATIAL & TEMPORAL FEATURE ENGINEERING</span><br>
                        <span class="comment"># A. Haversine Distance Function (etl.py lines 95-103)</span><br>
                        <span class="function">def</span> haversine_distance(lat1, lon1, lat2, lon2):<br>
                        &nbsp;&nbsp;R = 6371000  <span class="comment"># Earth radius in meters</span><br>
                        &nbsp;&nbsp;dlat = np.radians(lat2 - lat1)<br>
                        &nbsp;&nbsp;dlon = np.radians(lon2 - lon1)<br>
                        &nbsp;&nbsp;a = np.sin(dlat/2)**2 + np.cos(np.radians(lat1)) * np.cos(np.radians(lat2)) * np.sin(dlon/2)**2<br>
                        &nbsp;&nbsp;<span class="function">return</span> 6371000 * 2 * np.arcsin(np.sqrt(a))<br><br>
                        <span class="comment"># B. Calculate trip displacement (start ‚Üí end distance)</span><br>
                        trips['displacement'] = haversine_distance(<br>
                        &nbsp;&nbsp;trips['start_lat'], trips['start_lon'],<br>
                        &nbsp;&nbsp;trips['end_lat'], trips['end_lon']<br>
                        )<br><br>
                        <span class="comment"># C. Campus Corridor Flagging (geofencing)</span><br>
                        trips['is_campus'] = (<br>
                        &nbsp;&nbsp;((trips['start_lat'] >= 40.435) & (trips['start_lat'] <= 40.450) &<br>
                        &nbsp;&nbsp;&nbsp;(trips['start_lon'] >= -79.970) & (trips['start_lon'] <= -79.940)) |<br>
                        &nbsp;&nbsp;((trips['end_lat'] >= 40.435) & (trips['end_lat'] <= 40.450) &<br>
                        &nbsp;&nbsp;&nbsp;(trips['end_lon'] >= -79.970) & (trips['end_lon'] <= -79.940))<br>
                        )<br><br>
                        <span class="comment"># D. Integration Index (etl.py lines 161-179)</span><br>
                        <span class="comment"># For each bus stop, count bike trips within 400m</span><br>
                        <span class="function">for</span> idx, stop <span class="function">in</span> bus_stops.iterrows():<br>
                        &nbsp;&nbsp;distances = haversine_distance(stop['latitude'], stop['longitude'],<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stations['Latitude'], stations['Longitude'])<br>
                        &nbsp;&nbsp;nearest_dock_dist = distances.min()<br>
                        &nbsp;&nbsp;nearby_station_ids = stations[distances < 400]['Id']<br>
                        &nbsp;&nbsp;bike_trips_nearby = trips[trips['Start Station Id'].isin(nearby_station_ids)].shape[0]<br><br>
                        &nbsp;&nbsp;<span class="comment"># Integration Index = (Bus Boardings √ó log(Bike Trips + 1)) / Distance</span><br>
                        &nbsp;&nbsp;bus_stops.loc[idx, 'integration_index'] = (<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;stop['bus_boardings'] * np.log(bike_trips_nearby + 1) / nearest_dock_dist<br>
                        &nbsp;&nbsp;)
                    </div>
                    <div class="nb-output">
                        <strong>‚úì Feature Engineering Complete:</strong><br>
                        ‚Ä¢ <strong>Integration Index</strong> calculated for 7,075 bus stops<br>
                        ‚Ä¢ Top Score: <strong>3,732</strong> (7th St & Penn Ave ‚Äî Golden Triangle)<br>
                        ‚Ä¢ Average Score: <strong>4.4</strong> (median: 0.8, showing heavy right-skew)<br>
                        ‚Ä¢ Campus Corridor: <strong>379,039 trips</strong> (68.1% of total) flagged via geofence<br>
                        ‚Ä¢ Interpretation: <em>High Bus Volume + High Bike Activity + Close Proximity = High Integration Potential</em><br><br>
                        <strong>Exported to:</strong> <code style="background: #ffe066; padding: 2px 6px;">./processed_data/bus_stops_geo.csv</code>
                    </div>
                </div>

                <!-- CELL 3: CLUSTERING -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>3. Unsupervised Learning: Trip Archetypes</h3>
                        <p>Using K-Means clustering on trip duration, displacement, and start hour to categorize rider behavior patterns <em>without labeled training data</em>. This reveals latent behavioral segments for targeted policy interventions.</p>
                        <p><strong>Algorithm Rationale:</strong></p>
                        <ul>
                            <li><strong>K-Means (k=4):</strong> Chosen for interpretability. Silhouette analysis validated 4 as optimal cluster count (score: 0.68).</li>
                            <li><strong>Feature Scaling:</strong> StandardScaler ensures duration (seconds), displacement (meters), and hour (0-23) contribute equally.</li>
                            <li><strong>Feature Selection:</strong> Duration + Displacement capture trip purpose better than speed alone. Hour captures temporal behavior (commute vs leisure).</li>
                        </ul>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 3. K-MEANS CLUSTERING (etl.py lines 196-223)</span><br>
                        <span class="function">from</span> sklearn.cluster <span class="function">import</span> KMeans<br>
                        <span class="function">from</span> sklearn.preprocessing <span class="function">import</span> StandardScaler<br><br>
                        <span class="comment"># Prepare features (Duration, Displacement, Hour)</span><br>
                        features = trips[['Duration', 'displacement', 'hour']].dropna()<br>
                        scaler = StandardScaler()<br>
                        features_scaled = scaler.fit_transform(features)<br><br>
                        <span class="comment"># Fit K-Means (k=4 determined via elbow method + silhouette)</span><br>
                        kmeans = KMeans(n_clusters=4, random_state=42, n_init=10)<br>
                        trips['archetype'] = kmeans.fit_predict(features_scaled)<br><br>
                        <span class="comment"># Label clusters based on centroid characteristics</span><br>
                        cluster_stats = trips.groupby('archetype').agg({<br>
                        &nbsp;&nbsp;'Duration': 'mean',<br>
                        &nbsp;&nbsp;'displacement': 'mean',<br>
                        &nbsp;&nbsp;'hour': 'mean'<br>
                        })<br><br>
                        <span class="comment"># Assign semantic labels (manual inspection of centroids)</span><br>
                        archetype_map = {<br>
                        &nbsp;&nbsp;0: 'Commuter',    <span class="comment"># Short duration, peak hours (17.7h avg)</span><br>
                        &nbsp;&nbsp;1: 'Errand',      <span class="comment"># Medium duration, mid-day (14.8h)</span><br>
                        &nbsp;&nbsp;2: 'Last-Mile',   <span class="comment"># Very short, morning (9.3h)</span><br>
                        &nbsp;&nbsp;3: 'Leisure'      <span class="comment"># Long duration (73.2 min avg!)</span><br>
                        }<br>
                        trips['archetype_label'] = trips['archetype'].map(archetype_map)
                    </div>
                    <div class="nb-output">
                        <strong>‚úì Identified 4 Behavioral Archetypes:</strong><br>
                        1. <strong>Commuter (47.9% ‚Äî 266,603 trips)</strong>: Avg 7.7 min, 836m displacement, peak at 5:47 PM (evening commute)<br>
                        2. <strong>Last-Mile (32.8% ‚Äî 182,663 trips)</strong>: Avg 7.0 min, 910m, peak at 9:18 AM (connects to morning transit)<br>
                        3. <strong>Errand (15.7% ‚Äî 87,128 trips)</strong>: Avg 20.1 min, 3,359m displacement, peak at 2:48 PM (mid-day shopping/errands)<br>
                        4. <strong>Leisure (3.6% ‚Äî 20,043 trips)</strong>: Avg <strong>73.2 min</strong>, 737m (!), peak at 2:24 PM (weekend exploration, circular routes)<br><br>
                        <strong>Key Insight:</strong> Leisure trips show <em>high duration + low displacement</em>, suggesting recreational loops (riverwalk, parks). Commuter trips are the inverse: efficient A-to-B travel.<br><br>
                        <strong>Exported to:</strong> <code style="background: #ffe066; padding: 2px 6px;">./processed_data/archetypes.csv</code>
                    </div>
                    <div class="nb-output" style="padding:10px;">
                        <canvas id="notebookChart5" style="max-height:400px;"></canvas>
                    </div>
                </div>

                <!-- CELL 3B: STATION √ó ARCHETYPE ANALYSIS -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>3B. Station Behavioral Profiling</h3>
                        <p>After identifying trip archetypes, we reverse the analysis: <em>which stations generate which behaviors?</em> This reveals "station personalities" critical for targeted operational decisions.</p>
                        <p><strong>Methodology:</strong></p>
                        <ul>
                            <li><strong>Percentage Calculation:</strong> For each station, calculate % of trips matching each archetype (Commuter/Last-Mile/Errand/Leisure)</li>
                            <li><strong>Statistical Significance:</strong> Only stations with 50+ total trips included (prevents noise from low-volume stations)</li>
                            <li><strong>Top 3 Selection:</strong> Identify top 3 stations with highest percentage for each archetype</li>
                        </ul>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 3B. STATION ARCHETYPE PROFILING (etl.py lines 580-617)</span><br>
                        <span class="comment"># Calculate percentage of each archetype per station</span><br>
                        trips_clean['archetype_label'] = trips_clean['archetype'].map(archetype_map)<br><br>
                        <span class="function">for</span> archetype <span class="function">in</span> ['Commuter', 'Last-Mile', 'Errand', 'Leisure']:<br>
                        &nbsp;&nbsp;<span class="comment"># Count trips by station for this archetype</span><br>
                        &nbsp;&nbsp;station_counts = trips_clean.groupby(['Start Station Name', 'archetype_label']).size()<br><br>
                        &nbsp;&nbsp;<span class="comment"># Get total trips per station</span><br>
                        &nbsp;&nbsp;station_totals = trips_clean.groupby('Start Station Name').size()<br><br>
                        &nbsp;&nbsp;<span class="comment"># Calculate percentage</span><br>
                        &nbsp;&nbsp;station_archetype_pct = (station_counts / station_totals) * 100<br><br>
                        &nbsp;&nbsp;<span class="comment"># Filter: only stations with 50+ trips</span><br>
                        &nbsp;&nbsp;archetype_data = station_archetype_pct[station_totals >= 50]<br><br>
                        &nbsp;&nbsp;<span class="comment"># Get top 3 by percentage</span><br>
                        &nbsp;&nbsp;top_3 = archetype_data.nlargest(3)<br>
                        &nbsp;&nbsp;<span class="function">print</span>(f"{archetype}: {top_3}")
                    </div>
                    <div class="nb-output">
                        <strong>‚úì Station Behavioral Profiles Identified:</strong><br><br>
                        <strong>Commuter Hotspots:</strong><br>
                        ‚Ä¢ <strong>Schenley Dr & Schenley Dr Ext: 64.8%</strong> (12,721 of 19,637 trips) ‚Äî Pure commuter station at CMU campus edge<br>
                        ‚Ä¢ <strong>Forbes Ave @ TCS Hall (CMU): 61.2%</strong> (10,168 of 16,607 trips) ‚Äî Academic commuter hub<br><br>
                        <strong>Last-Mile Leaders:</strong><br>
                        ‚Ä¢ <strong>Boulevard of the Allies & Parkview Ave: 46.9%</strong> (13,859 of 29,538 trips) ‚Äî Critical transit feeder<br>
                        ‚Ä¢ <strong>S Millvale Ave & Centre Ave: 43.4%</strong> (4,045 of 9,310 trips) ‚Äî East End connector<br><br>
                        <strong>Errand Centers:</strong><br>
                        ‚Ä¢ <strong>Wilkinsburg Park & Ride: 68.4%!</strong> (444 of 649 trips) ‚Äî Suburban shopping/service trips dominate<br>
                        ‚Ä¢ <strong>Second Ave & Tecumseh St: 61.4%</strong> (181 of 295 trips) ‚Äî South Side errand node<br><br>
                        <strong>Leisure Destinations:</strong><br>
                        ‚Ä¢ <strong>South Side Trail & S 4th St: 19.0%</strong> (712 of 3,739 trips) ‚Äî Recreational waterfront<br>
                        ‚Ä¢ <strong>Liberty Ave & Stanwix St: 18.9%</strong> (1,218 of 6,438 trips) ‚Äî Downtown leisure hub<br><br>
                        <strong>Key Insight:</strong> Stations have distinct behavioral "DNA". Schenley Dr is 64.8% commuter vs South Side Trail at 19.0% leisure‚Äîthese require completely different fleet rebalancing strategies.<br><br>
                        <strong>Exported to:</strong> <code style="background: #ffe066; padding: 2px 6px;">./processed_data/station_archetypes.csv</code>
                    </div>
                </div>

                <!-- CELL 4: TEMPORAL ANALYSIS -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>4. Temporal Dynamics: The "Student Effect"</h3>
                        <p>Comparing Campus Corridor (CMU/Pitt bounding box) vs City-Wide ridership reveals the massive impact of the academic calendar. This segmentation is critical for capacity planning and seasonal rebalancing strategies.</p>
                        <p><strong>Why Daily Granularity Matters:</strong></p>
                        <ul>
                            <li><strong>365-Day Timeseries:</strong> Monthly averages hide spikes (orientation week, finals week, spring break). Daily data preserves these anomalies.</li>
                            <li><strong>Campus Geofencing:</strong> Trips flagged if start OR end falls within 40.435-40.450¬∞N, -79.970 to -79.940¬∞W (covers CMU, Pitt, Shadyside).</li>
                            <li><strong>Separate Campus/City Arrays:</strong> Enables filtering in FIG 1A without aggregating to monthly averages (user requirement: "make it still daily detail").</li>
                        </ul>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 4. CAMPUS vs CITY DAILY TIMESERIES (etl.py lines 401-413)</span><br>
                        <span class="comment"># Generate daily counts, split by campus flag</span><br>
                        trips['date'] = trips['Start Date'].dt.date<br>
                        daily_pogoh = trips.groupby('date').size().reset_index(name='trips')<br><br>
                        <span class="comment"># Campus trips (is_campus == True)</span><br>
                        daily_campus = trips[trips['is_campus']].groupby('date').size().reset_index(name='trips')<br>
                        daily_campus['date_str'] = pd.to_datetime(daily_campus['date']).dt.strftime('%Y-%m-%d')<br><br>
                        <span class="comment"># City trips (is_campus == False)</span><br>
                        daily_city = trips[~trips['is_campus']].groupby('date').size().reset_index(name='trips')<br>
                        daily_city['date_str'] = pd.to_datetime(daily_city['date']).dt.strftime('%Y-%m-%d')<br><br>
                        <span class="comment"># Ensure all 365 dates present (fill gaps with 0)</span><br>
                        all_dates = pd.DataFrame({'date_str': daily_pogoh['date_str']})<br>
                        daily_campus_full = all_dates.merge(daily_campus[['date_str', 'trips']], on='date_str', how='left').fillna(0)<br>
                        daily_city_full = all_dates.merge(daily_city[['date_str', 'trips']], on='date_str', how='left').fillna(0)<br><br>
                        <span class="comment"># Export 3 parallel 365-element arrays</span><br>
                        daily_timeseries = {<br>
                        &nbsp;&nbsp;'dates': daily_pogoh['date_str'].tolist(),<br>
                        &nbsp;&nbsp;'pogoh_trips': daily_pogoh['trips'].tolist(),<br>
                        &nbsp;&nbsp;'pogoh_campus_trips': daily_campus_full['trips'].astype(int).tolist(),<br>
                        &nbsp;&nbsp;'pogoh_city_trips': daily_city_full['trips'].astype(int).tolist()<br>
                        }
                    </div>
                    <div class="nb-output">
                        <strong>‚úì Temporal Segmentation Results:</strong><br>
                        ‚Ä¢ <strong>Campus Corridor:</strong> 379,039 trips (68.1% of system volume)<br>
                        ‚Ä¢ <strong>Winter Drop:</strong> Campus ridership drops 63% in Jan vs Sep (academic break)<br>
                        ‚Ä¢ <strong>City Stability:</strong> Non-campus trips remain stable year-round, indicating resident commuter dependence<br>
                        ‚Ä¢ <strong>Peak Day:</strong> September 26, 2025 (3,800+ trips ‚Äî Fall semester peak + ideal weather)<br>
                        ‚Ä¢ <strong>Trough Day:</strong> January 4, 2025 (412 trips ‚Äî winter break nadir)<br><br>
                        <strong>Policy Implication:</strong> Campus fleet should be <em>dynamically scaled</em> with academic calendar. City corridors need year-round minimum service.<br><br>
                        <strong>Exported to:</strong> <code style="background: #ffe066; padding: 2px 6px;">./processed_data/daily_timeseries.csv</code> (365 rows √ó 4 columns)
                    </div>
                    <div class="nb-output" style="padding:10px;">
                        <canvas id="notebookChart2" style="max-height:450px;"></canvas>
                    </div>
                </div>

                <!-- CELL 5: SEASONAL PATTERNS -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>5. Season √ó Hour Matrix</h3>
                        <p>A heatmap revealing the exact time-windows of highest demand. This drives our rebalancing schedules.</p>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 5. PIVOT TABLE ANALYSIS</span><br>
                        matrix = trips.groupby(['season', 'hour']).size().unstack()<br>
                        sns.heatmap(matrix, cmap='Blues')
                    </div>
                    <div class="nb-output">
                        <strong>Peak Load:</strong> Fall Semester, 5:00 PM (Commute + Class End).<br>
                        <strong>Policy Insight:</strong> The "Winter Gap" is visible as a uniform cooling across all hours, not just peaks.
                    </div>
                    <div class="nb-output" style="padding:10px;">
                        <canvas id="notebookChart8" style="width:100%; height:500px;"></canvas>
                    </div>
                </div>

                <!-- CELL 6: CORRELATION -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>6. Statistical Correlation: Bus vs Bike</h3>
                        <p>Do busy bus stops actually generate bike trips? We test this hypothesis with linear regression.</p>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 6. LINEAR REGRESSION</span><br>
                        slope, r_value, p_value = linregress(bus_vol, integration_score)<br>
                        print(f"R-Squared: {r_value**2}")
                    </div>
                    <div class="nb-output">
                        <strong>Result: R¬≤ = 0.372 (p < 0.001)</strong><br>
                        There is a <strong>moderate positive correlation</strong>. While bus volume is a predictor, it's not the <em>only</em> factor. Bike infrastructure (lanes) and topography play huge unmeasured roles.
                    </div>
                    <div class="nb-output" style="padding:20px;">
                        <canvas id="notebookChart7" style="width:100%; height:600px;"></canvas>
                    </div>
                </div>

                <!-- CELL 9: Combined into CELL 5 above (Seasonal Heatmap) -->

                <!-- CELL 10 -->
                <div class="nb-cell">
                    <div class="nb-md">
                        <h3>Strategic Integration: Top 10 Multimodal Nodes</h3>
                        <p>New analysis identifying high-impact integration opportunities. We filter for the top 10 bus stops (by volume) that are within 400m of a bikeshare station.</p>
                    </div>
                    <div class="nb-input">
                        <span class="comment"># 10. FINDING "LAST MILE LEADERS"</span><br>
                        bus_stops_near_pogoh = bus_stops[bus_stops['bike_trips_nearby'] > 0]<br>
                        top_10 = bus_stops_near_pogoh.nlargest(10, 'bus_boardings')<br>
                        print(top_10[['stop_name', 'bus_boardings', 'bike_trips_nearby']])
                    </div>
                    <div class="nb-output">
                        <strong>Top 10 PRT Stops Near POGOH Stations:</strong><br>
                        <div id="top10-list" style="font-family: 'JetBrains Mono'; font-size: 0.85rem; margin-top: 10px; line-height: 1.8;">
                            Loading...
                    </div>
                        <br>
                        <strong>Key Finding:</strong> #1 Node shows proven multimodal success. Gaps exist where high bus volume doesn't translate to bike usage (infrastructure opportunity).
                    </div>
                </div>

                    </div>
        </section>
        <!-- VIEW 3: ABOUT / CONTEXT (NEW) -->
        <section id="about-view" class="view-section">
            
            <!-- ROW 1: FIELD LOG -->
            <div class="context-row">
                <!-- COLUMN A: NARRATIVE -->
                <div style="padding-right: 20px;">
                    <div class="log-header">// ORIGIN: JAKARTA (CGK) ‚Üí DESTINATION: PITTSBURGH (PIT)</div>
                    <p style="line-height: 1.7; margin-bottom: 20px;">
                        Relocating from Jakarta to Pittsburgh fundamentally shifted my mobility baseline from 'Park & Ride' to 'Bike & Bus'. In Jakarta, my daily commute often involved a car trip to the MRT followed by 45++ minutes of friction on the Tol Desari.
                    </p>
                    <p style="line-height: 1.7; margin-bottom: 30px;">
                        Arriving here introduced a new variable: Micro-mobility in a Winter Climate. Thanks to integrated transit access (via my CMU ID), POGOH became my critical First/Last-mile connector. The challenge shifted from traffic volume to thermal endurance. But the result‚Äîavoiding the despair of gridlock‚Äîis transformative. This project explores that efficiency.
                    </p>

                    <div class="log-header">// DATA_SOURCES</div>
                    <ul style="list-style: none; padding: 0; line-height: 2;">
                        <li>üìÑ <a href="https://data.wprdc.org/dataset/pogoh-trip-data" target="_blank" style="color:var(--blueprint); text-decoration:none; border-bottom:1px solid var(--blueprint);">POGOH Trip Data (WPRDC)</a></li>
                        <li>üöå <a href="https://data.wprdc.org/dataset/port-authority-monthly-average-stop-usage" target="_blank" style="color:var(--blueprint); text-decoration:none; border-bottom:1px solid var(--blueprint);">PRT Transit Data (ArcGIS Hub)</a></li>
                    </ul>
                    </div>

                <!-- COLUMN B: PHOTO EVIDENCE -->
                <div class="photo-grid">
                    <div class="evidence-tile">
                        <img src="img/pogoh.jpg" alt="POGOH Bike" style="width: 100%; height: 200px; object-fit: cover;">
                        <span class="evidence-label">NODE A: POGOH in Bridge City</span>
                    </div>
                    <div class="evidence-tile">
                        <img src="img/prt_bus.jpg" alt="PRT Bus" style="width: 100%; height: 200px; object-fit: cover;">
                        <span class="evidence-label">NODE B: PRT in AAA East Liberty</span>
                    </div>
                    <div class="evidence-tile">
                        <img src="img/mrt_jakarta.jpg" alt="MRT Jakarta" style="width: 100%; height: 200px; object-fit: cover;">
                        <span class="evidence-label">ORIGIN: MRT JAKARTA</span>
                </div>
                    <div class="evidence-tile">
                        <img src="img/antasari_traffic.jpg" alt="Jakarta Traffic" style="width: 100%; height: 200px; object-fit: cover;">
                        <span class="evidence-label">FRICTION: TOL DESARI JAM</span>
                    </div>
                    </div>
                    </div>

            <!-- ROW 2: AUTHOR PROFILE -->
            <div class="author-section">
                <!-- SIDEBAR -->
                <div class="author-sidebar">
                    <div class="author-photo">
                        <img src="img/rizaldy_batik.JPG" alt="Rizaldy Utomo">
                    </div>
                    <a href="https://www.linkedin.com/in/rizaldykautsar/" target="_blank" class="connect-btn">LINKEDIN</a>
                    <a href="https://github.com/rzrizaldy" target="_blank" class="connect-btn">GITHUB</a>
                    <a href="https://bukugambar.replit.app/" target="_blank" class="connect-btn" style="background: var(--blueprint);">BUKUGAMBAR.AI</a>
                </div>

                <!-- BIO TEXT -->
                <div class="author-bio">
                    <div class="log-header">// RIZALDY AL KAUTSAR UTOMO</div>
                    <div style="background: var(--ink); color: white; display: inline-block; padding: 8px 12px; font-family: 'JetBrains Mono', monospace; font-weight: bold; margin-bottom: 25px; font-size: 0.85rem;">
                        rutomo@andrew.cmu.edu<br>
                        (Public Policy, Analytics, AI Management @ CMU)
            </div>
                    
                    <p><strong>I am on a mission to architect responsible AI solutions for developing markets, ensuring that technology helps people thrive rather than just survive.</strong></p>

                    <p>My professional journey began at the intersection of policy and analytics in Indonesia‚Äôs telecommunications sector. During seven years at Telkomsel, I saw how mobility data can drive critical decisions... deploying credit-scoring models that expanded financial inclusion and designing campaign algorithms that lifted revenue.</p>

                    <p>Curiosity carried me from Bandung to Pittsburgh. A full-ride LPDP scholarship made it possible to study at Carnegie Mellon, where I bring an underrepresented international perspective to AI policy. Recognized with the Ganesha Karsa award (ITB).</p>

                    <p>Tinkering is in my DNA. EcoFlow grew from GIS into a crowd-intelligence tourism system (incubated by Singtel). Bukugambar.ai began as weekend playtime with my son and became an AI sketchbook that turns text or photos into coloring-page outlines.</p>

                    <p style="margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; font-style: italic;">
                        Seeking Summer 2026 Internship in Analytics or AI Solutions in the US.
                    </p>
                </div>
            </div>

        </section>
    </main>


    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="data.js"></script>

    <script>
        // Register Chart.js datalabels plugin globally but disable by default
        Chart.register(ChartDataLabels);
        Chart.defaults.plugins.datalabels.display = false;

        // --- MODE SWITCHING ---
        function toggleMode(mode) {
            // Update Buttons
            document.querySelectorAll('.retro-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            // Update View
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById(mode + (mode === 'viz' ? '-view' : '-view')).classList.add('active');

            // Map Resize Fix
            if(mode === 'viz' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        // --- POPULATE SIDEBAR METRICS FROM REAL DATA (if elements exist) ---
        document.addEventListener('DOMContentLoaded', function() {
            // Only populate if sidebar elements exist (removed from current design)
            if(document.getElementById('integration-score')) {
            const avgIntegration = busStopsData.reduce((sum, stop) => sum + stop.integration_score, 0) / busStopsData.length;
                const normalizedScore = Math.min(avgIntegration * 100, 10).toFixed(1);
            document.getElementById('integration-score').textContent = normalizedScore + '/10';
            }

            if(document.getElementById('integration-context')) {
            const topStop = busStopsData.reduce((max, stop) => stop.integration_score > max.integration_score ? stop : max);
            document.getElementById('integration-context').innerHTML =
                `<span style="color:var(--terminal-green)">Top: ${topStop.name}</span><br>High overlap in Downtown, Gaps in outer neighborhoods.`;
            }

            if(document.getElementById('lastmile-trips')) {
            const lastMileArch = archetypesData.find(a => a.label === 'Last-Mile');
            if (lastMileArch) {
                document.getElementById('lastmile-trips').textContent = lastMileArch.count.toLocaleString();
                }
            }

            // Populate Top 10 list in notebook
            if(document.getElementById('top10-list') && topPrtPogohData) {
                let listHTML = '<table style="width:100%; border-collapse: collapse;">';
                listHTML += '<tr style="border-bottom: 1px solid #ccc; font-weight: bold;"><td>#</td><td>Stop Name</td><td style="text-align:right;">Bus Boardings</td><td style="text-align:right;">Bike Trips (400m)</td></tr>';
                topPrtPogohData.stops.forEach((stop, idx) => {
                    listHTML += `<tr style="border-bottom: 1px solid #eee;">
                        <td>${idx + 1}.</td>
                        <td>${stop}</td>
                        <td style="text-align:right; color: #2B4CFF; font-weight: bold;">${topPrtPogohData.bus_boardings[idx].toLocaleString()}</td>
                        <td style="text-align:right; color: #FF2B8C; font-weight: bold;">${topPrtPogohData.bike_trips_nearby[idx].toLocaleString()}</td>
                    </tr>`;
                });
                listHTML += '</table>';
                document.getElementById('top10-list').innerHTML = listHTML;
            }
        });

        // --- MAP INIT ---
        const map = L.map('map').setView([40.445, -79.98], 13);
        
        // CartoDB Light (Greyscale) for Schematic Look
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // Layer Groups for Filtering
        const busLayer = L.layerGroup().addTo(map);
        const bikeLayer = L.layerGroup().addTo(map);

        // Custom Square Icon for POGOH
        const squareIcon = L.divIcon({
            className: 'custom-icon',
            html: `<div style="width:14px; height:14px; background:#FF2B8C; border:2px solid black;"></div>`,
            iconSize: [14, 14],
            iconAnchor: [7, 7]
        });

        // Function to render map markers
        function renderMap(filteredBusStops, filteredBikeStations) {
            busLayer.clearLayers();
            bikeLayer.clearLayers();

            // Render Bus Stops
            filteredBusStops.forEach(stop => {
            L.circleMarker(stop.loc, {
                radius: Math.sqrt(stop.vol)/2,
                fillColor: '#2B4CFF',
                color: '#2B4CFF',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.4
                }).addTo(busLayer).bindPopup(`<strong>BUS STOP</strong><br>${stop.name}<br>Vol: ${stop.vol}<br>Hood: ${stop.hood}`);
            });

            // Render Bike Stations
            filteredBikeStations.forEach(st => {
            L.marker(st.loc, {icon: squareIcon})
                 .addTo(bikeLayer)
             .bindPopup(`<strong>POGOH STATION</strong><br>${st.name}`);
        });
        }

        // Initial Render
        renderMap(busStopsData, bikeStationsData);


        // --- CHARTS ---

        // Store temporal charts globally for filter updates
        let pogohDailyChart = null;
        let prtMonthlyChart = null;

        // 1A. POGOH Daily Chart (365 Days Real Data)
        pogohDailyChart = new Chart(document.getElementById('pogohDailyChart'), {
            type: 'line',
            data: {
                labels: dailyTimeseriesData.dates,
                datasets: [{
                    label: 'POGOH Daily Trips',
                    data: dailyTimeseriesData.pogoh_trips,
                    borderColor: '#FF2B8C',
                    backgroundColor: 'rgba(255, 43, 140, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return context.parsed.y.toLocaleString() + ' trips';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 12,
                            font: { size: 9 }
                        }
                    },
                    y: {
                        title: { display: true, text: 'Daily Trips', font: { size: 10 } },
                        grid: { color: '#eee' },
                        ticks: { font: { size: 9 } }
                    }
                }
            }
        });

        // 1B. PRT Monthly Chart (Full Historical Data)
        prtMonthlyChart = new Chart(document.getElementById('prtMonthlyChart'), {
            type: 'line',
            data: {
                labels: monthlyTrendsData.all_prt_labels, // Full historical dates
                datasets: [{
                    label: 'PRT Bus Ridership (Monthly Total)',
                    data: monthlyTrendsData.all_prt_values.map(v => v <= 0 ? null : v), // Clean 0s to avoid drops
                    borderColor: '#2B4CFF',
                    backgroundColor: 'rgba(43, 76, 255, 0.1)',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointStyle: 'circle',
                    fill: true,
                    tension: 0.3,
                    spanGaps: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString() + ' riders/month';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'category', // Discrete axis for dates
                        grid: { display: false },
                        ticks: { 
                            font: { size: 10 },
                            maxTicksLimit: 8 
                        }
                    },
                    y: {
                        title: { display: true, text: 'Monthly Ridership', font: { size: 10 } },
                        grid: { color: '#ddd', borderDash: [5,5] },
                        min: 0, // Don't start below 0
                        ticks: {
                            callback: function(value) {
                                if (value === 0) return ''; // Hide 0 label if desired, but min:0 usually handles it well
                                return (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });

        // 2. Radar Chart (Archetypes) - REAL DATA
        new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: {
                labels: archetypesData.map(a => a.label),
                datasets: [{
                    label: 'Trip Distribution',
                    data: archetypesData.map(a => (a.count / 5565) * 100), // Normalize to percentage
                    borderColor: '#2B4CFF',
                    backgroundColor: 'rgba(43, 76, 255, 0.2)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: '#ccc' },
                        grid: { color: '#ddd' },
                        pointLabels: { font: { family: 'Space Grotesk', size: 12 } }
                    }
                }
            }
        });

        // 3. Polar Chart (Directionality) - DASHBOARD
        new Chart(document.getElementById('polarChart'), {
            type: 'polarArea',
            data: {
                labels: directionalityData.labels,
                datasets: [{
                    label: 'Trip Direction',
                    data: directionalityData.values,
                    backgroundColor: [
                        'rgba(43, 76, 255, 0.7)',   // N - Blueprint Blue
                        'rgba(0, 184, 132, 0.7)',   // NE - Terminal Green
                        'rgba(255, 77, 0, 0.7)',    // E - Safety Orange
                        'rgba(255, 43, 140, 0.7)',  // SE - Alert Pink
                        'rgba(43, 76, 255, 0.5)',   // S
                        'rgba(0, 184, 132, 0.5)',   // SW
                        'rgba(255, 77, 0, 0.5)',    // W
                        'rgba(255, 43, 140, 0.5)'   // NW
                    ],
                    borderColor: '#000',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'right', 
                        labels: { 
                            font: { family: 'JetBrains Mono', size: 10 },
                            boxWidth: 12,
                            padding: 15,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1) + '%';
                                        return {
                                            text: `${label}: ${percentage}`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: isNaN(data.datasets[0].data[i]),
                                            lineCap: 'butt',
                                            lineDash: [],
                                            lineDashOffset: 0,
                                            lineJoin: 'miter',
                                            lineWidth: 1,
                                            strokeStyle: '#000',
                                            pointStyle: 'rectRot',
                                            datasetIndex: 0
                                        };
                                    });
                                }
                                return [];
                            }
                        } 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return `${label}: ${value.toLocaleString()} trips (${percentage})`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        ticks: { backdropColor: 'transparent', font: { size: 9 } },
                        pointLabels: { display: true, font: { size: 11, weight: 'bold' } }
                    }
                }
            }
        });

        // 4. Demographics Chart (Stacked Bar) - DASHBOARD
        // Store chart globally for updates
        let demographicsChart = null;

        function renderDemographicsChart(sortBy = 'total') {
            // Prepare data for sorting
            const stationData = demographicsData.stations.map((station, idx) => {
                const member = demographicsData.data[demographicsData.rider_types[0]][idx];
                const casual = demographicsData.data[demographicsData.rider_types[1]][idx];
                const total = member + casual;
                return {
                    station: station,
                    member: member,
                    casual: casual,
                    total: total,
                    casualPct: total > 0 ? (casual / total) * 100 : 0,
                    memberPct: total > 0 ? (member / total) * 100 : 0
                };
            });

            // Sort based on selected option
            if (sortBy === 'total') {
                stationData.sort((a, b) => b.total - a.total);
            } else if (sortBy === 'casual') {
                stationData.sort((a, b) => b.casualPct - a.casualPct);
            } else if (sortBy === 'member') {
                stationData.sort((a, b) => b.memberPct - a.memberPct);
            }

            // Take top 10
            const top10 = stationData.slice(0, 10);

            const chartData = {
                labels: top10.map(d => d.station),
                datasets: [
                    {
                        label: demographicsData.rider_types[0], // Member
                        data: top10.map(d => d.member),
                        backgroundColor: '#2B4CFF',
                    borderColor: '#000',
                    borderWidth: 1
                    },
                    {
                        label: demographicsData.rider_types[1], // Casual
                        data: top10.map(d => d.casual),
                        backgroundColor: '#FF4D00',
                        borderColor: '#000',
                        borderWidth: 1
                    }
                ]
            };

            if (demographicsChart) {
                demographicsChart.data = chartData;
                demographicsChart.options.plugins.datalabels = {
                    display: true,
                    formatter: (value, context) => {
                        const dataIndex = context.dataIndex;
                        const casualPct = top10[dataIndex].casualPct;
                        return context.datasetIndex === 1 ? casualPct.toFixed(1) + '% casual' : '';
                    },
                    anchor: 'end',
                    align: 'right',
                    color: '#333',
                    font: { size: 9, weight: 'bold', family: 'JetBrains Mono' },
                    offset: 4
                };
                demographicsChart.update();
            } else {
                demographicsChart = new Chart(document.getElementById('demographicsChart'), {
                    type: 'bar',
                    data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                            legend: { position: 'top', labels: { font: { family: 'JetBrains Mono', size: 9 } } },
                            datalabels: {
                                display: true,
                                formatter: (value, context) => {
                                    const dataIndex = context.dataIndex;
                                    const casualPct = top10[dataIndex].casualPct;
                                    return context.datasetIndex === 1 ? casualPct.toFixed(1) + '% casual' : '';
                                },
                                anchor: 'end',
                                align: 'right',
                                color: '#333',
                                font: { size: 9, weight: 'bold', family: 'JetBrains Mono' },
                                offset: 4
                            }
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { stacked: true, ticks: { font: { size: 8 } } }
                }
            }
                });
            }
        }

        // Initial render
        renderDemographicsChart('total');

        // Add event listener for sort dropdown
        document.getElementById('demo-sort').addEventListener('change', function() {
            renderDemographicsChart(this.value);
        });

        // 5. Duration Distribution Chart (Histogram) - DASHBOARD
        new Chart(document.getElementById('durationChart'), {
            type: 'bar',
            data: {
                labels: durationDistData.bins.map(b => b.toFixed(0)),
                datasets: [{
                    label: 'Trips',
                    data: durationDistData.counts,
                    backgroundColor: '#00B884',
                    borderColor: '#000',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        title: { display: true, text: 'Duration (min)', font: { size: 10 } },
                        ticks: { maxRotation: 45, font: { size: 8 } }
                    },
                    y: {
                        title: { display: true, text: 'Count', font: { size: 10 } },
                        grid: { color: '#eee' }
                    }
                }
            }
        });

        // 5B. Seasonal Hourly Patterns - REAL DATA
        // Data structure: seasonalHeatmapData.data[hour_index][season_index]
        // Seasons order: Winter, Spring, Summer, Fall
        const seasonalHourly = {
            winter: seasonalHeatmapData.data.map(row => row[0]),
            spring: seasonalHeatmapData.data.map(row => row[1]),
            summer: seasonalHeatmapData.data.map(row => row[2]),
            fall:   seasonalHeatmapData.data.map(row => row[3])
        };

        new Chart(document.getElementById('seasonalChart'), {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + 'h'),
                datasets: [
                    {
                        label: '‚ùÑÔ∏è Winter (Dec-Feb)',
                        data: seasonalHourly.winter,
                        borderColor: '#2B4CFF',
                        backgroundColor: 'rgba(43, 76, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'üå∏ Spring (Mar-May)',
                        data: seasonalHourly.spring,
                        borderColor: '#00B884',
                        backgroundColor: 'rgba(0, 184, 132, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: '‚òÄÔ∏è Summer (Jun-Aug)',
                        data: seasonalHourly.summer,
                        borderColor: '#FF4D00',
                        backgroundColor: 'rgba(255, 77, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'üçÇ Fall (Sep-Nov)',
                        data: seasonalHourly.fall,
                        borderColor: '#FF2B8C',
                        backgroundColor: 'rgba(255, 43, 140, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { font: { family: 'JetBrains Mono', size: 9 } } }
                },
                scales: {
                    x: { title: { display: true, text: 'Hour of Day', font: { size: 10 } } },
                    y: { title: { display: true, text: 'Total Trips', font: { size: 10 } }, grid: { color: '#eee' } }
                }
            }
        });

        // 6. Correlation Scatter Chart - DASHBOARD
        new Chart(document.getElementById('correlationChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Bus Stops',
                    data: correlationData.bus_boardings.map((x, i) => ({
                        x: x,
                        y: correlationData.integration_index[i]
                    })),
                    backgroundColor: 'rgba(43, 76, 255, 0.6)',
                    borderColor: '#2B4CFF',
                    pointRadius: 2
                },
                {
                    label: `R¬≤=${correlationData.regression.r_squared.toFixed(3)}`,
                    data: [
                        { x: 0, y: correlationData.regression.intercept },
                        { x: Math.max(...correlationData.bus_boardings),
                          y: correlationData.regression.intercept + correlationData.regression.slope * Math.max(...correlationData.bus_boardings) }
                    ],
                    type: 'line',
                    borderColor: '#FF4D00',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { font: { size: 9 } } } },
                scales: {
                    x: { title: { display: true, text: 'Bus Boardings', font: { size: 9 } } },
                    y: { title: { display: true, text: 'Integration', font: { size: 9 } } }
                }
            }
        });

        // 7. Heatmap Chart - DASHBOARD (Removed/Replaced by Top 10)
        // The user wanted Top 10 PRT-POGOH instead of just another heatmap here, or alongside.
        // I removed the old heatmap snippet to make space or just kept it? 
        // The prompt said "stacked bar chart the prt bus stop top 10". 
        // I will ADD the Top 10 chart logic here.

        // 8. Top 10 PRT Stops Near POGOH (Grouped Bar, Dual Axis)
        new Chart(document.getElementById('topPrtChart'), {
            type: 'bar',
            data: {
                labels: topPrtPogohData.stops.map(s => s.replace(' AT ', ' @ ').substring(0, 20)), 
                datasets: [
                    {
                        label: 'Bus Boardings',
                        data: topPrtPogohData.bus_boardings,
                        backgroundColor: '#2B4CFF',
                        yAxisID: 'y',
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'Bike Trips (400m)',
                        data: topPrtPogohData.bike_trips_nearby,
                        backgroundColor: '#FF2B8C',
                        yAxisID: 'y', // Use same axis? No, different scales.
                        // Chart.js Bar chart with different scales on same axis (Horizontal) is tricky.
                        // Let's try using secondary X axis (since indexAxis is y).
                        xAxisID: 'x1',
                        barPercentage: 0.6,
                        categoryPercentage: 0.8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                         mode: 'index',
                         intersect: false
                    }
                },
                scales: {
                    y: {
                        ticks: { font: { size: 9 } }
                    },
                    x: {
                        type: 'linear',
                        display: true,
                        position: 'top',
                        title: { display: true, text: 'Bus Boardings', color: '#2B4CFF' },
                        grid: { display: false }
                    },
                    x1: {
                        type: 'linear',
                        display: true,
                        position: 'bottom',
                        title: { display: true, text: 'Nearby Bike Trips', color: '#FF2B8C' },
                        grid: { display: false }
                    }
                }
            }
        });

        // FIG 11: Station Archetypes Chart (Grouped Horizontal Bar)
        const archetypeColors = {
            'Commuter': '#2B4CFF',
            'Last-Mile': '#FF9500',
            'Errand': '#34C759',
            'Leisure': '#FF2B8C'
        };

        const archetypeOrder = ['Commuter', 'Last-Mile', 'Errand', 'Leisure'];
        const archetypeDatasets = archetypeOrder.map(archetype => {
            const data = stationArchetypesData[archetype];
            return {
                label: archetype,
                data: data.percentages,
                backgroundColor: archetypeColors[archetype],
                barPercentage: 0.7,
                categoryPercentage: 0.85,
                stations: data.stations,
                trip_counts: data.trip_counts,
                total_trips: data.total_trips
            };
        });

        // Combine all station labels (3 per archetype = 12 total)
        const allStationLabels = archetypeOrder.flatMap(archetype =>
            stationArchetypesData[archetype].stations.map(s => s.substring(0, 30))
        );

        new Chart(document.getElementById('stationArchetypesChart'), {
            type: 'bar',
            data: {
                labels: allStationLabels,
                datasets: archetypeDatasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { family: 'JetBrains Mono', size: 11 },
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    title: {
                        display: true,
                        text: 'Percentage of trips matching each archetype (Top 3 stations per behavior type)',
                        font: { family: 'JetBrains Mono', size: 11 },
                        padding: { bottom: 15 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const archetype = context.dataset.label;
                                const idx = context.dataIndex % 3; // 3 stations per archetype
                                const station = context.dataset.stations[idx];
                                const pct = context.dataset.data[idx];
                                const trips = context.dataset.trip_counts[idx];
                                const total = context.dataset.total_trips[idx];
                                return `${archetype}: ${pct}% (${trips.toLocaleString()} of ${total.toLocaleString()} trips)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Percentage of Total Trips at Station', font: { size: 12 } },
                        ticks: { callback: function(value) { return value + '%'; } },
                        grid: { color: '#e0e0e0' }
                    },
                    y: {
                        ticks: {
                            font: { family: 'JetBrains Mono', size: 9 },
                            autoSkip: false
                        },
                        grid: { display: false }
                    }
                }
            }
        });

        // --- APPLY FILTERS BUTTON ---
        document.getElementById('apply-filters-btn').addEventListener('click', function() {
            const corridorFilter = document.getElementById('corridor-filter').value;
            const stationFilter = document.getElementById('station-filter').value;

            // 1. Filter Data
            let filteredStops = busStopsData;
            let filteredStations = bikeStationsData;

            // Neighborhood Mapping for Corridors
            const hoods = {
                'campus': ['Squirrel Hill North', 'Squirrel Hill South', 'North Oakland', 'Central Oakland', 'South Oakland', 'West Oakland', 'Shadyside', 'Terrace Village'],
                'downtown': ['Central Business District', 'Bluff'],
                'strip': ['Strip District'],
                'east-liberty': ['East Liberty', 'Larimer', 'Homewood North', 'Homewood South', 'Homewood West', 'Lincoln-Lemington-Belmar']
            };

            // Apply corridor filter to bus stops
            if (corridorFilter !== 'system' && hoods[corridorFilter]) {
                filteredStops = busStopsData.filter(s => hoods[corridorFilter].includes(s.hood));

                // Also filter POGOH stations by proximity to filtered bus stops
                // Keep only POGOH stations within the same geographic area
                const filteredStopCoords = filteredStops.map(s => s.loc);
                if (filteredStopCoords.length > 0) {
                    filteredStations = bikeStationsData.filter(station => {
                        // Check if station is near any of the filtered bus stops (within ~2km)
                        return filteredStopCoords.some(stopLoc => {
                            const dist = Math.sqrt(
                                Math.pow((station.loc[0] - stopLoc[0]) * 111, 2) +
                                Math.pow((station.loc[1] - stopLoc[1]) * 111, 2)
                            );
                            return dist < 2; // 2km radius
                        });
                    });
                }
            }

            // Station Filter Logic
            if (stationFilter === 'top10-pogoh') {
                // Sort stations by trips (descending) and take top 10
                filteredStations = [...bikeStationsData].sort((a, b) => b.trips - a.trips).slice(0, 10);
            } else if (stationFilter === 'top10-prt') {
                // Sort bus stops by volume (descending) and take top 10
                // Also apply corridor filter if active? Yes, intersect.
                filteredStops = filteredStops.sort((a, b) => b.vol - a.vol).slice(0, 10);
            }

            // 2. Update Map
            renderMap(filteredStops, filteredStations);

            // 3. Update Metrics (if elements exist)
            const avgScore = filteredStops.length > 0
                ? (filteredStops.reduce((sum, s) => sum + s.integration_score, 0) / filteredStops.length)
                : 0;

            // Only update if element exists (removed from current design)
            if(document.getElementById('integration-score')) {
                const normScore = Math.min(avgScore * 100, 10).toFixed(1);
                document.getElementById('integration-score').textContent = normScore + '/10';
            }

            if(filteredStops.length > 0 && document.getElementById('integration-context')) {
                 const topStop = filteredStops.reduce((max, stop) => stop.integration_score > max.integration_score ? stop : max);
                 document.getElementById('integration-context').innerHTML = `<span style="color:var(--terminal-green)">Top: ${topStop.name}</span>`;
            }

            // 4. Update Status Text
            let filterStatusText = '';
            if (corridorFilter === 'campus') filterStatusText = 'üéì Campus';
            else if (corridorFilter === 'downtown') filterStatusText = 'üèôÔ∏è Downtown';
            else if (corridorFilter === 'strip') filterStatusText = 'üè≠ Strip';
            else if (corridorFilter === 'east-liberty') filterStatusText = 'üöá East Lib';
            else filterStatusText = 'üåê System';

            if (stationFilter === 'top10-pogoh') filterStatusText += ' + üèÜ Top 10 POGOH';
            if (stationFilter === 'top10-prt') filterStatusText += ' + üöå Top 10 PRT';

            document.getElementById('filter-status').textContent = filterStatusText;

            // 5. Update Temporal Charts (FIG 1A - POGOH Daily with real daily data)
            if (pogohDailyChart && corridorFilter === 'campus') {
                // Show campus daily trips (365 days detail)
                pogohDailyChart.data.labels = dailyTimeseriesData.dates;
                pogohDailyChart.data.datasets[0].data = dailyTimeseriesData.pogoh_campus_trips;
                pogohDailyChart.data.datasets[0].label = 'POGOH Campus Daily Trips';
                pogohDailyChart.options.scales.y.title.text = 'Daily Trips (Campus)';
                pogohDailyChart.update();
            } else if (pogohDailyChart && (corridorFilter === 'downtown' || corridorFilter === 'strip' || corridorFilter === 'east-liberty')) {
                // For downtown/other non-campus corridors, show city (non-campus) daily data
                pogohDailyChart.data.labels = dailyTimeseriesData.dates;
                pogohDailyChart.data.datasets[0].data = dailyTimeseriesData.pogoh_city_trips;
                pogohDailyChart.data.datasets[0].label = 'POGOH City Daily Trips';
                pogohDailyChart.options.scales.y.title.text = 'Daily Trips (Non-Campus)';
                pogohDailyChart.update();
            } else if (pogohDailyChart) {
                // Show full daily timeseries for system-wide
                pogohDailyChart.data.labels = dailyTimeseriesData.dates;
                pogohDailyChart.data.datasets[0].data = dailyTimeseriesData.pogoh_trips;
                pogohDailyChart.data.datasets[0].label = 'POGOH Daily Trips';
                pogohDailyChart.options.scales.y.title.text = 'Daily Trips';
                pogohDailyChart.update();
            }

            // Note: FIG 1B (PRT Monthly) remains system-wide as PRT data is aggregated at system level
            // and historical trends are meaningful for comparing against POGOH system-wide patterns

            // Visual feedback
            const btn = this;
            btn.textContent = '‚úì FILTERS APPLIED';
            btn.style.background = 'var(--blueprint)';
            setTimeout(() => {
                btn.textContent = '‚ö° APPLY FILTERS';
                btn.style.background = 'var(--terminal-green)';
            }, 1500);
        });

        // --- NOTEBOOK CHARTS (CODE & METHODS TAB) ---

        // NOTEBOOK CHART 2: Campus vs City Temporal (Line Chart)
        new Chart(document.getElementById('notebookChart2'), {
            type: 'line',
            data: {
                labels: monthlyTrendsData.labels,
                datasets: [
                    {
                        label: 'Campus POGOH (Daily Avg)',
                        data: monthlyTrendsData.pogoh_campus_daily,
                        borderColor: '#FF4D00',
                        borderWidth: 2,
                        pointRadius: 4,
                        tension: 0.2
                    },
                    {
                        label: 'City POGOH (Daily Avg)',
                        data: monthlyTrendsData.pogoh_city_daily,
                        borderColor: '#00B884',
                        borderWidth: 2,
                        pointRadius: 4,
                        tension: 0.2
                    },
                    {
                        label: 'PRT Bus (Daily Avg)',
                        data: monthlyTrendsData.prt_daily_avg,
                        borderColor: '#2B4CFF',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true, labels: { font: { family: 'JetBrains Mono', size: 10 } } } },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { color: '#eee' }, title: { display: true, text: 'Daily Avg Trips' } }
                }
            }
        });


        // NOTEBOOK CHART 4: Directionality (Polar Area Chart)
        if(document.getElementById('notebookChart4')) {
            new Chart(document.getElementById('notebookChart4'), {
                type: 'polarArea',
                data: {
                    labels: directionalityData.labels,
                    datasets: [{
                        data: directionalityData.values,
                        backgroundColor: [
                            'rgba(43, 76, 255, 0.6)',
                            'rgba(0, 184, 132, 0.6)',
                            'rgba(255, 77, 0, 0.6)',
                            'rgba(255, 43, 140, 0.6)',
                            'rgba(43, 76, 255, 0.4)',
                            'rgba(0, 184, 132, 0.4)',
                            'rgba(255, 77, 0, 0.4)',
                            'rgba(255, 43, 140, 0.4)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'right', 
                            labels: { 
                                font: { family: 'JetBrains Mono', size: 10 },
                                boxWidth: 12,
                                padding: 10,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1) + '%';
                                            return {
                                                text: `${label}: ${percentage}`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: isNaN(data.datasets[0].data[i]),
                                                lineCap: 'butt',
                                                lineDash: [],
                                                lineDashOffset: 0,
                                                lineJoin: 'miter',
                                                lineWidth: 1,
                                                strokeStyle: '#000',
                                                pointStyle: 'rectRot',
                                                datasetIndex: 0
                                            };
                                        });
                                    }
                                    return [];
                                }
                            } 
                        }
                    },
                    scales: {
                        r: {
                            ticks: { backdropColor: 'transparent' }
                        }
                    }
                }
            });
        }

        // NOTEBOOK CHART 5: Demographics (Stacked Bar Chart)
        new Chart(document.getElementById('notebookChart5'), {
            type: 'bar',
            data: {
                labels: demographicsData.stations,
                datasets: demographicsData.rider_types.map((type, idx) => ({
                    label: type,
                    data: demographicsData.data[type],
                    backgroundColor: idx === 0 ? '#2B4CFF' : '#FF4D00',
                    borderColor: '#000',
                    borderWidth: 1
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: true } },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { stacked: true, ticks: { font: { size: 9 } } }
                }
            }
        });


        // NOTEBOOK CHART 7: Correlation Scatter
        new Chart(document.getElementById('notebookChart7'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Bus Stops',
                    data: correlationData.bus_boardings.map((x, i) => ({
                        x: x,
                        y: correlationData.integration_index[i]
                    })),
                    backgroundColor: 'rgba(43, 76, 255, 0.5)',
                    borderColor: '#2B4CFF',
                    pointRadius: 3
                },
                {
                    label: `Regression (R¬≤=${correlationData.regression.r_squared.toFixed(3)})`,
                    data: [
                        { x: 0, y: correlationData.regression.intercept },
                        { x: Math.max(...correlationData.bus_boardings),
                          y: correlationData.regression.intercept + correlationData.regression.slope * Math.max(...correlationData.bus_boardings) }
                    ],
                    type: 'line',
                    borderColor: '#FF4D00',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    x: { title: { display: true, text: 'Bus Boardings (Daily Avg)' } },
                    y: { title: { display: true, text: 'Integration Index' } }
                }
            }
        });

        // NOTEBOOK CHART 8: Heatmap (Season x Hour) - REAL DATA
        const heatmapCanvas = document.getElementById('notebookChart8');
        const ctx = heatmapCanvas.getContext('2d');

        // Set canvas dimensions
        heatmapCanvas.width = heatmapCanvas.offsetWidth;
        heatmapCanvas.height = 500;

        // Use Seasonal Data
        const cols = seasonalHeatmapData.seasons; // Winter, Spring, Summer, Fall
        const rows = seasonalHeatmapData.hours;   // 0-23
        const data = seasonalHeatmapData.data;    // [hour][season]

        // Calculate cell dimensions
        const margin = { top: 40, right: 80, bottom: 40, left: 60 };
        const cellWidth = (heatmapCanvas.width - margin.left - margin.right) / cols.length;
        const cellHeight = (heatmapCanvas.height - margin.top - margin.bottom) / rows.length;

        // Improved Seaborn-style color gradient (Blues - better contrast)
        function getHeatColor(value, maxValue) {
            const normalized = value / maxValue;
            if (normalized < 0.2) {
                const t = normalized / 0.2;
                return `rgb(${Math.round(247 - 32 * t)}, ${Math.round(251 - 21 * t)}, ${Math.round(255 - 16 * t)})`;
            } else if (normalized < 0.4) {
                const t = (normalized - 0.2) / 0.2;
                return `rgb(${Math.round(215 - 63 * t)}, ${Math.round(230 - 54 * t)}, ${Math.round(239 - 59 * t)})`;
            } else if (normalized < 0.6) {
                const t = (normalized - 0.4) / 0.2;
                return `rgb(${Math.round(152 - 60 * t)}, ${Math.round(176 - 61 * t)}, ${Math.round(180 - 49 * t)})`;
            } else if (normalized < 0.8) {
                const t = (normalized - 0.6) / 0.2;
                return `rgb(${Math.round(92 - 39 * t)}, ${Math.round(115 - 53 * t)}, ${Math.round(131 - 58 * t)})`;
            } else {
                const t = (normalized - 0.8) / 0.2;
                return `rgb(${Math.round(53 - 45 * t)}, ${Math.round(62 - 54 * t)}, ${Math.round(73 - 65 * t)})`;
            }
        }

        // Find max value for normalization
        const maxHeatmapValue = Math.max(...data.flat());

        // Draw heatmap cells
        rows.forEach((hour, h) => {
            cols.forEach((season, s) => {
                const value = data[h][s];
                const x = margin.left + s * cellWidth;
                const y = margin.top + h * cellHeight;
                const normalized = value / maxHeatmapValue;

                // Draw cell
                ctx.fillStyle = getHeatColor(value, maxHeatmapValue);
                ctx.fillRect(x, y, cellWidth - 1, cellHeight - 1);

                // REMOVED TEXT INSIDE CELLS as requested by user
                /* 
                if (value > maxHeatmapValue * 0.05) {
                    ctx.fillStyle = normalized > 0.5 ? '#fff' : '#000';
                    ctx.font = 'bold 12px JetBrains Mono';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(value.toLocaleString(), x + cellWidth/2, y + cellHeight/2);
                }
                */
            });
        });

        // Draw axes labels
        ctx.fillStyle = '#000';
        ctx.font = 'bold 11px Space Grotesk';
        ctx.textAlign = 'center';

        // X-axis (Seasons)
        cols.forEach((season, s) => {
            const x = margin.left + s * cellWidth + cellWidth/2;
            ctx.fillText(season.toUpperCase(), x, margin.top - 10);
        });

        // Y-axis (Hours) - every 2 hours
        ctx.textAlign = 'right';
        rows.forEach((hour, h) => {
            if (hour % 2 === 0) {
                const y = margin.top + h * cellHeight + cellHeight/2;
                ctx.fillText(hour + 'h', margin.left - 10, y);
            }
        });

        // Axis titles
        ctx.font = 'bold 13px Space Grotesk';
        ctx.textAlign = 'center';
        ctx.fillText('SEASON', heatmapCanvas.width / 2, margin.top - 28);

        ctx.save();
        ctx.translate(15, heatmapCanvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('HOUR OF DAY', 0, 0);
        ctx.restore();

        // Draw color legend
        const legendX = heatmapCanvas.width - margin.right + 20;
        const legendY = margin.top;
        const legendHeight = 200;
        const legendWidth = 20;

        // Gradient legend
        for (let i = 0; i < legendHeight; i++) {
            const value = (legendHeight - i) / legendHeight;
            ctx.fillStyle = getHeatColor(value * maxHeatmapValue, maxHeatmapValue);
            ctx.fillRect(legendX, legendY + i, legendWidth, 1);
        }

        // Legend border
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 1;
        ctx.strokeRect(legendX, legendY, legendWidth, legendHeight);

        // Legend labels
        ctx.fillStyle = '#000';
        ctx.font = '10px JetBrains Mono';
        ctx.textAlign = 'left';
        ctx.fillText(maxHeatmapValue.toFixed(0), legendX + legendWidth + 5, legendY + 5);
        ctx.fillText('0', legendX + legendWidth + 5, legendY + legendHeight);

        // 9. Neighborhood Integration Chart (New)
        // Aggregate integration scores by neighborhood
        const neighborhoodScores = {};
        const neighborhoodCounts = {};

        busStopsData.forEach(stop => {
            if (stop.hood && stop.hood !== 'Unknown') {
                // EXCLUDE HAZELWOOD as requested by user
                if (stop.hood.toLowerCase() !== 'hazelwood') {
                    neighborhoodScores[stop.hood] = (neighborhoodScores[stop.hood] || 0) + stop.integration_score;
                    neighborhoodCounts[stop.hood] = (neighborhoodCounts[stop.hood] || 0) + 1;
                }
            }
        });

        // Calculate averages
        const hoodAvgScores = Object.keys(neighborhoodScores).map(hood => ({
            hood: hood,
            avg: neighborhoodScores[hood] / neighborhoodCounts[hood]
        })).sort((a, b) => b.avg - a.avg).slice(0, 8); // Top 8

        new Chart(document.getElementById('neighborhoodIntegrationChart'), {
            type: 'bar',
            data: {
                labels: hoodAvgScores.map(h => h.hood),
                datasets: [{
                    label: 'Avg Integration Score',
                    data: hoodAvgScores.map(h => h.avg),
                    backgroundColor: '#00B884',
                    borderColor: '#000',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { title: { display: true, text: 'Integration Index' }, grid: { color: '#eee' } }
                }
            }
        });

        // 10. Top 15 Individual Stops by Integration Index (New)
        // Sort all stops by integration score
        const topIndexStops = [...busStopsData]
            .filter(s => s.hood && s.hood.toLowerCase() !== 'hazelwood') // Filter out Hazelwood here too
            .sort((a, b) => b.integration_score - a.integration_score)
            .slice(0, 15);

        new Chart(document.getElementById('topIndexChart'), {
            type: 'bar',
            data: {
                labels: topIndexStops.map(s => {
                    // Shorten long names for display but keep full name for tooltip
                    const shortName = s.name.replace(' AT ', ' @ ').substring(0, 20);
                    return shortName.length < s.name.length ? shortName + '...' : shortName;
                }),
                datasets: [{
                    label: 'Integration Score',
                    data: topIndexStops.map(s => s.integration_score),
                    backgroundColor: '#FF2B8C',
                    borderColor: '#000',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                // Show full stop name in tooltip
                                return topIndexStops[context[0].dataIndex].name;
                            },
                            label: function(context) {
                                return 'Integration Index: ' + context.parsed.x.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Integration Index', font: { size: 11 } },
                        grid: { display: true, color: '#eee' }
                    },
                    y: {
                        ticks: {
                            font: { size: 10, weight: 'bold' },
                            color: '#000',
                            padding: 5
                        }
                    }
                }
            }
        });

    </script>
</body>
</html>